apiVersion: batch/v1
kind: CronJob
metadata:
  name: thinkingengine-tester
  namespace: thinkingengine
spec:
  schedule: "10 10 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: tester
              image: thinkingdata/trino:476
              command: ["/bin/bash", "-c"]
              args:
                - |-
                  # Trino ÊúçÂä°Âú∞ÂùÄ
                  TRINO_URL="http://thinkingengine-trino:8080"
                  TRINO_USER="admin"
                  CATALOG="hive"
                  SCHEMA="te"

                  TIMESTAMP=$(date +%Y%m%d%H%M)
                  TABLE="test_${TIMESTAMP}"
                  # =========================================

                  # Ê£ÄÊü• trino cli ÊòØÂê¶ÂÆâË£Ö
                  if ! command -v trino &> /dev/null; then
                      echo "‚ùå Error: 'trino' CLI tool is not found in PATH."
                      exit 1
                  fi

                  echo "üöÄ Connecting to Trino at $TRINO_URL..."

                  SQL_COMMANDS=$(cat <<EOF
                  -- 1. ÂàõÂª∫ Schema (ÂπÇÁ≠â: Â¶ÇÊûúÂ≠òÂú®ÂàôÂøΩÁï•)
                  CREATE SCHEMA IF NOT EXISTS ${CATALOG}.${SCHEMA};

                  -- 2. ÂàáÊç¢ÂΩìÂâç‰ºöËØùÁöÑ Catalog Âíå Schema
                  USE ${CATALOG}.${SCHEMA};

                  -- 3. ÈáçÂª∫Ë°® (ÂπÇÁ≠â: Â¶ÇÊûúÂ≠òÂú®ÂàôÂà†Èô§ÔºåÁ°Æ‰øùÁä∂ÊÄÅÈáçÁΩÆ)
                  DROP TABLE IF EXISTS ${TABLE};

                  CREATE TABLE ${TABLE}(
                      c1 bigint,
                      c2 varchar
                  );

                  -- 4. ÊèíÂÖ•ÊµãËØïÊï∞ÊçÆ
                  INSERT INTO ${TABLE} VALUES
                      (1,'a'),
                      (2,'b'),
                      (3,'c'),
                      (4,'d'),
                      (5,'e');

                  -- 5. È™åËØÅÁªìÊûú
                  SHOW TABLES;
                  SELECT * FROM ${TABLE};
                  EOF
                  )

                  # ÊâßË°åÂëΩ‰ª§
                  # --output-format ALIGNED ËÆ©ËæìÂá∫Âú®ÁªàÁ´ØÊõ¥Â•ΩÁúã
                  trino --server "$TRINO_URL" \
                        --user "$TRINO_USER" \
                        --output-format ALIGNED \
                        --execute "$SQL_COMMANDS"

                  if [ $? -eq 0 ]; then
                      echo "‚úÖ SQL execution completed successfully!"
                  else
                      echo "‚ùå SQL execution failed."
                      exit 1
                  fi
          restartPolicy: Never
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
